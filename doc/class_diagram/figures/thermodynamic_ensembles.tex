\begin{scope}[shift={($(Material.north) + (-5 cm, 85 cm)$)}]
    \begin{package}{Thermodynamic ensembles}
        
        \begin{scope}[local bounding box=EnsembleAlgorithms]
            \begin{abstractclass}[text width=\smallTextWidth]{EnsembleAlgorithms}{0, 0}
                \operation[0]{setAlgorithms()} % in constructor?
                \operation{chooseAlgorithm()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{setAlgorithms()}
            }
            
            \begin{class}[text width=\smallTextWidth]{CanonicalAlgorithms}{-4, -3}
                \inherit{EnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{GrandCanonicalAlgorithms}{4, -3}
                \inherit{EnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{IsobariclAlgorithms}{0, -5.5}
                \inherit{EnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(EnsembleAlgorithms.north) + (15 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{MetropolisAlgorithm}{0, 0}
                \operation[0]{try()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{try()}
            }
            
            \begin{abstractclass}[text width=\smallTextWidth]{OneSphereChange}{-4, -3}
                \inherit{MetropolisAlgorithm}
                \operationsImplementation{}
                \operation[0]{chooseComponent()}
                \operation{chooseSphere()}
                \operation[0]{applySmallChange()}
                \operation[0]{calculateEnergy()}
                \operation[0]{testMetroplis()}
                \operation[0]{update()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{chooseComponent()}
                \operation{applySmallChange()}
                \operation{calculateEnergy()}
                \operation{testMetroplis()}
                \operation{update()}
            }
            
            \begin{class}[text width=\smallTextWidth]{OneSphereMove}{-4, -8.5}
                \inherit{OneSphereChange}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{OneSphereRotation}{-4, -13}
                \inherit{OneSphereChange}
                \operationsImplementation{}
            \end{class}
            
            \def\operationsImplementation{
                \operation{try()}
                % to fill
            }
            
            \begin{class}[text width=\smallTextWidth]{OneSphereExchange}{4, -3}
                \inherit{MetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{TwoSpheresSwitch}{12, -3}
                \inherit{MetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
        \end{scope}

    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{EnsembleAlgorithms}{algo}{1..*}{MetropolisAlgorithm}
    
    \aggregation{MetropolisAlgorithm}{thermostat}{1}{Thermostat}

    \aggregation{OneSphereMove}{dipSpheres}{2}{DipolarSpheres}
    \aggregation{OneSphereMove}{boxedSpheres}{2}{BoxedSpheres}
    \aggregation{OneSphereMove}{random}{2}{RandomPositions}
    \aggregation{OneSphereMove}{short}{2}{ShortInteraction}
    \aggregation{OneSphereMove}{walls}{1}{WallsInteraction}
    \aggregation{OneSphereMove}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{OneSphereMove}{field}{1}{FieldInteraction}
    %\compostion{OneSphereMove}{observables}{3}{Observables}
    
    \aggregation{OneSphereRotation}{dipSpheres}{2}{DipolarSpheres}
    \aggregation{OneSphereRotation}{random}{2}{RandomOrientations}
    \aggregation{OneSphereRotation}{dipolar}{2}{DipolarInteractionFacade}
    %\compostion{OneSphereRotation}{observables}{3}{Observables}
    
    \aggregation{TwoSpheresSwitch}{dipSpheres}{2}{DipolarSpheres}
    \aggregation{TwoSpheresSwitch}{boxedSpheres}{2}{BoxedSpheres}
    \aggregation{TwoSpheresSwitch}{short}{2}{ShortInteraction}
    \aggregation{TwoSpheresSwitch}{walls}{1}{WallsInteraction}
    \aggregation{TwoSpheresSwitch}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{TwoSpheresSwitch}{field}{1}{FieldInteraction}
    %\compostion{TwoSpheresSwitch}{observables}{3}{Observables}
    
    \aggregation{OneSphereExchange}{dipSpheres}{2}{DipolarSpheres}
    \aggregation{OneSphereExchange}{boxedSpheres}{2}{BoxedSpheres}
    \aggregation{OneSphereExchange}{short}{2}{ShortInteraction}
    \aggregation{OneSphereExchange}{walls}{1}{WallsInteraction}
    \aggregation{OneSphereExchange}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{OneSphereExchange}{field}{1}{FieldInteraction}
    \aggregation{OneSphereExchange}{reservoir}{2}{SpheresReservoir}
    %\compostion{OneSphereExchange}{observables}{3}{Observables}
\end{scope}
