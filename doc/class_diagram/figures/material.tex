\begin{scope}[local bounding box=Material, opacity=0.25]
    \begin{package}{Material}
        
        \begin{scope}[opacity=1]
            \begin{abstractclass}[text width=\largeTextWidth]{PeriodicBox}{0, 0}
                \operation{setSize(size\type{double[3]})}
                \operation{getSize()\type{double[3]}}
                \operation{distance(position1\type{double[3]},
                                    position2\type{double[3]})\type{double}}
                \operation{vector(position1\type{double[3]},
                                  position2\type{double[3]})\type{double[3]}}
                \operation[0]{folded(position\type{double[3]})\type{double[3]}}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{folded(position\type{double[3]})\type{double[3]}}
            }
            \begin{comment}
                \begin{class}[text width=\largeTextWidth]{XYZPeriodicBox}{0, -4.5}
                    \inherit{PeriodicBox}
                    \operationsImplementation{}
                \end{class}

                \begin{class}[text width=\largeTextWidth]{XYPeriodicBox}{0, -6.5}
                    \inherit{PeriodicBox}
                    \operationsImplementation{}
                \end{class}
            \end{comment}
        \end{scope}
        
        \begin{scope}[shift={($(PeriodicBox.north) + (-11 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{ParallelepipedDomain}{0, 0}
                \operation{construct(periodicBox\type{PeriodicBox}, origin\type{double[3]},
                                     size\type{double[3]})}
                \operation{destroy()}
                \operation{getVolume()}
                \operation{isInside(position\type{double[3]})\type{bool}}
                \operation{randomPosition()\type{double[3]}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(PeriodicBox.north) + (11 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{ReciprocalLattice}{0, 0}
                \operation{contruct(periodicBox\type{PeriodicBox}, numbers\type{int[3]})}
                \operation{destroy()}
                \operation{getNumbers()\type{int[3]}}
            \end{abstractclass}
            \begin{comment}
            \begin{class}[text width=\mediumTextWidth]{NullReciprocalLattice}{0, -4}
                \inherit{ReciprocalLattice}
            \end{class}
            \end{comment}
        \end{scope}
        
        \begin{scope}[shift={($(PeriodicBox.north) + (-10 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{Temperature}{0, 0}
                \operation{set(temperature\type{double})}
                \operation{getTemperature()\type{double}}
            \end{abstractclass}
            % Parallel Tempering?
        \end{scope}
        
        \begin{scope}[shift={($(Temperature.north) + (-8 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{FieldExpression}{0, 0}
                \operation{set(fieldParameters\type{FieldParameters})}
                \operation{get(position\type{double[3]})\type{double[3]}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(ParallelepipedDomain.north)!0.5!
                                (FieldExpression.north) + (0 cm, 8.5 cm)$)}, opacity=1]
            \begin{class}[text width=\largeTextWidth]{ExternalFieldFacade}{0, 0}
                \operation{construct(parallelepipedDomain\type{ParallelepipedDomain},
                    fieldExpression\type{FieldExpression})}
                \operation{destroy()}
                \operation{get(position\type{double[3]})\type{double[3]}}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(PeriodicBox.north) + (28 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{ParticlesNumber}{0, 0}
                \operation{set(number\type{int})}
                \operation{get()\type{int}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(ParticlesNumber.north) + (7 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{ParticlesDiameter}{0, 0}
                \operation{set(diameter\type{double}, minFactor\type{double})}
                \operation{get()\type{double}}
                \operation{getMin()\type{double}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(ParticlesDiameter.north) + (7 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{ParticlesMomentNorm}{0, 0}
                \operation{set(norm\type{double})}
                \operation{get()\type{double}}
            \end{abstractclass}
            \begin{comment}
                \begin{class}[text width=\smallTextWidth]{NullMomentsNorm}{0, -3}
                    \inherit{ParticlesMomentNorm}
                \end{class}
            \end{comment}
        \end{scope}
        
          \begin{scope}[shift={($(ParticlesMomentNorm.north) + (7 cm, 0)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{ParticlesChemicalPotential}{0, 0}
                \operation{set(density\type{double}, excess\type{double})}
                \operation{getDensity()\type{double}}
                \operation{getExcess()\type{double}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(ParticlesDiameter.north) + (-9 cm, 6 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{InterParticlesDiameter}{0, 0}
                \operation{construct(diameter1\type{ParticlesDiameter},
                                     diameter2\type{ParticlesDiameter},
                                     offset\type{double})}
                \operation{destroy()}
                \operation{get()\type{double}}
                \operation{getMin()\type{double}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(InterParticlesDiameter.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{ParticlesPositions}{0, 0}
                \operation{construct(periodicBox\type{PeriodicBox},
                                      number\type{ParticlesNumber})}
                \operation{detroy()}
                \operation{set(iParticle\type{int}, position\type{double[3]})}
                \operation{getNum()\type{int}}
                \operation{get(iParticle\type{int})\type{double[3]}}
                \operation{add(position\type{double[3]})}
                \operation{remove(iParticle\type{int})}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(InterParticlesDiameter.north) + (0 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractParticlesExchange}{0, 0}
                \operation{construct(particles\type{GenericParticles})}
                \operation{destroy()}
                \operation{add(particle\type{GenericParticle})}
                \operation{remove(iParticle\type{int})}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractParticlesExchange.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{MovedPositions}{0, 0}
                \operation{construct(positions\type{ParticlesPositions}, delta\type{double[3]},
                    adaptationFactor\type{double})}
                \operation{destroy()}
                \operation{increase()}
                \operation{decrease()}
                \operation{get(iParticle\type{int})\type{double[3]}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(ParticlesPositions.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{ParticlesOrientations}{0, 0}
                \operation{construct(number\type{ParticlesNumber})}
                \operation{detroy()}
                \operation{set(iParticle\type{int}, orientation\type{double[3]})}
                \operation{getNum()\type{int}}
                \operation{get(iParticle\type{int})\type{double[3]}}
                \operation{add(orientation\type{double[3]})}
                \operation{remove(iParticle\type{int})}
            \end{abstractclass}
            \begin{comment}
                \begin{class}[text width=\mediumTextWidth]{NullOrientations}{0, -5.5}
                    \inherit{ParticlesOrientations}
                \end{class}
            \end{comment}
        \end{scope}
        
        \begin{scope}[shift={($(MovedPositions.north -| ParticlesOrientations.north)$)},
                      opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{RotatedOrientations}{0, 0}
                \operation{construct(orientations\type{ParticlesOrientations}, delta\type{double},
                    adaptationFactor\type{double})}
                \operation{destroy()}
                \operation{increase()}
                \operation{decrease()}
                \operation{get(iParticle\type{int})\type{double[3]}}
            \end{abstractclass}
            \begin{comment}
                \begin{class}[text width=\mediumTextWidth]{NullRotatedOrientations}{0, -4.5}
                    \inherit{RotatedOrientations}
                \end{class}
            \end{comment}
        \end{scope}

        \begin{scope}[shift={($(ParticlesOrientations.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{ParticlesDipolarMoments}{0, 0}
                \operation{construct(momentNorm\type{ParticlesMomentNorm},
                                     orientations\type{ParticlesOrientations})}
                \operation{destroy()}
                \operation{getNum()\type{int}}
                \operation{get(iParticle\type{int})}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(ParticlesDipolarMoments.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractTotalMoment}{0, 0}
                \operation{construct(dipolarMoment\type{ParticlesDipolarMoments})}
                \operation{destroy()}
                \operation{set(totalMoment\type{double[3]})}
                \operation{reset()}
                \operation{get()\type{double[3]}}
                %\operation{rotationUpdate(old\type{Particle}, new\type{Particle})}
                %\operation{exchangeUpdate(particle\type{Particle})}
            \end{abstractclass}
        \end{scope}
        
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{ParallelepipedDomain}{periodicBox}{1}{PeriodicBox}
    \aggregation{ReciprocalLattice}{periodicBox}{1}{PeriodicBox}
    \aggregation{ExternalFieldFacade}{parallelepipedDomain}{1}{ParallelepipedDomain}
    \aggregation{ExternalFieldFacade}{fieldExpression}{1}{FieldExpression}
    
    \aggregation{InterParticlesDiameter}{diameter}{2}{ParticlesDiameter}
    \aggregation{ParticlesPositions}{periodicBox}{1}{PeriodicBox}
    \aggregation{ParticlesPositions}{number}{1}{ParticlesNumber}
    \aggregation{ParticlesOrientations}{number}{1}{ParticlesNumber}
    
    \aggregation{ParticlesDipolarMoments}{momentNorm}{1}{ParticlesMomentNorm}
    \aggregation{ParticlesDipolarMoments}{orientations}{1}{ParticlesOrientations}
    
    \aggregation{MovedPositions}{positions}{1}{ParticlesPositions}
    \aggregation{RotatedOrientations}{orientations}{1}{ParticlesOrientations}

    \aggregation{AbstractParticlesExchange}{number}{1}{ParticlesNumber}
    \aggregation{AbstractParticlesExchange}{positions}{1}{ParticlesPositions}
    \aggregation{AbstractParticlesExchange}{orientations}{1}{ParticlesOrientations}
    
    \aggregation{AbstractTotalMoment}{momentNorm}{1}{ParticlesDipolarMoments}
\end{scope}
