\begin{scope}[local bounding box=Material, opacity=0.5]
    \begin{package}{Material}
        
        \begin{scope}[opacity=1]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractPeriodicBox}{0, 0}
                \operation{setSize(size\type{double[3]})}
                \operation{getSize()\type{double[3]}}
                \operation{distance(position1\type{double[3]},
                                    position2\type{double[3]})\type{double}}
                \operation{vector(position1\type{double[3]},
                                  position2\type{double[3]})\type{double[3]}}
                \operation[0]{folded(position\type{double[3]})\type{double[3]}}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{folded(position\type{double[3]})\type{double[3]}}
            }
            
            \begin{class}[text width=\largeTextWidth]{XYZPeriodicBox}{0, -4}
                \inherit{AbstractPeriodicBox}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{XYPeriodicBox}{0, -6}
                \inherit{AbstractPeriodicBox}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractPeriodicBox.north) + (-11 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractParallelepipedDomain}{0, 0}
                \operation{construct(periodicBox\type{AbstractPeriodicBox}, origin\type{double[3]},
                                     size\type{double[3]})}
                \operation{destroy()}
                \operation{getVolume()}
                \operation{isInside(position\type{double[3]})\type{bool}}
                \operation{getInside(inUnitCube\type{double[3]})\type{double[3]}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractPeriodicBox.north) + (11 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractReciprocalLattice}{0, 0}
                \operation[0]{contruct(periodicBox\type{AbstractPeriodicBox}, numbers\type{int[3]})}
                \operation[0]{destroy()}
                \operation[0]{getNumbers()\type{int[3]}}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{contruct(periodicBox\type{AbstractPeriodicBox}, numbers\type{int[3]})}
                \operation{destroy()}
                \operation{getNumbers()\type{int[3]}}
            }
            
            \begin{class}[text width=\mediumTextWidth]{NullReciprocalLattice}{0, -4}
                \inherit{AbstractReciprocalLattice}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{ReciprocalLattice}{0, -7.5}
                \inherit{AbstractReciprocalLattice}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractPeriodicBox.north) + (-10 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractTemperature}{0, 0}
                \operation{set(temperature\type{double})}
                \operation{getTemperature()\type{double}}
            \end{abstractclass}
            % Parallel Tempering?
        \end{scope}
        
        \begin{scope}[shift={($(AbstractTemperature.north) + (-8 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractFieldExpression}{0, 0}
                \operation{set(fieldParameters\type{AbstractFieldParameters})}
                \operation{get(position\type{double[3]})\type{double[3]}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractParallelepipedDomain.north)!0.5!
                                (AbstractFieldExpression.north) + (0 cm, 7 cm)$)}, opacity=1]
            \begin{class}[text width=\largeTextWidth]{ExternalFieldFacade}{0, 0}
                \operation{construct(parallelepipedDomain\type{AbstractParallelepipedDomain},
                    fieldExpression\type{AbstractFieldExpression})}
                \operation{destroy()}
                \operation{get(position\type{double[3]})\type{double[3]}}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractFieldExpression.north) + (-9 cm, 0)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractChemicalPotential}{0, 0}
                \operation{set(density\type{double}, excess\type{double})}
                \operation{getDensity()\type{double}}
                \operation{getExcess()\type{double}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractPeriodicBox.north) + (28 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractParticlesNumber}{0, 0}
                \operation{set(number\type{int})}
                \operation{get()\type{int}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractParticlesNumber.north) + (0 cm, 9 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractDiameters}{0, 0}
                \operation{contruct(particlesNumberber\type{AbstractParticlesNumber})}
                \operation{destroy()}
                \operation[0]{set(iParticle\type{int}, diameter\type{double})}
                \operation[0]{get(iParticle\type{int})\type{double}}
                \operation[0]{add(diameter\type{double})}
                \operation[0]{remove(iParticle\type{int})}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{set(iParticle\type{int}, diameter\type{double})}
                \operation{get(iParticle\type{int})\type{double}}
                \operation{add(diameter\type{double})}
                \operation{remove(iParticle\type{int})}
            }
            
            \begin{class}[text width=\mediumTextWidth]{UniformDiameters}{0, -5}
                \inherit{AbstractDiameters}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(AbstractDiameters.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractMomentsNorm}{0, 0}
                \operation{contruct(particlesNumberber\type{AbstractParticlesNumber})}
                \operation{destroy()}
                \operation[0]{set(iParticle\type{int}, norm\type{double})}
                \operation[0]{get(iParticle\type{int})\type{double}}
                \operation[0]{add(norm\type{double})}
                \operation[0]{remove(iParticle\type{int})}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{set(iParticle\type{int}, norm\type{double})}
                \operation{get(iParticle\type{int})\type{double}}
                \operation{add(norm\type{double})}
                \operation{remove(iParticle\type{int})}
            }
        \end{scope}
        
        \begin{scope}[shift={($(AbstractDiameters.north) + (0 cm, 5 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractInterDiameters}{0, 0}
                \operation{construct(diameters1\type{AbstractDiameters},
                                     diameters2\type{AbstractDiameters},
                                     nonAdditivity\type{double})}
                \operation{destroy()}
                \operation{get(iParticle\type{int}, jParticle\type{int})\type{double}}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractInterDiameters.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractPositions}{0, 0}
                \operation{construct(periodicBox\type{AbstractPeriodicBox},
                                      particlesNumber\type{AbstractParticlesNumber})}
                \operation{detroy()}
                \operation{set(iParticle\type{int}, position\type{double[3]})}
                \operation{get(iParticle\type{int})\type{double[3]}}
                \operation{add(position\type{double[3]})}
                \operation{remove(iParticle\type{int})}
            \end{abstractclass}
        \end{scope}
        
        %\begin{scope}[shift={($(AbstractPeriodicBox.north) + (0 cm, 5 cm)$)}]
        %    \begin{abstractclass}[text width=\smallTextWidth]{AbstractBoxedParticles}{0, 0}
                %\operation[0]{accessibleVolume()\type{double}}
                %\operation[0]{isInside(position\type{double[3]})\type{bool}}
                %\operation{fold(position\type{double[3]})}
        %    \end{abstractclass}
        %\end{scope}
        
        \begin{scope}[shift={($(AbstractPositions.north) + (0 cm, 8 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractSmallMove}{0, 0}
                \operation{construct(positions\type{AbstractPositions})}
                \operation{destroy()}
                \operation{set(delta\type{double[3]})}
                \operation{get(iParticle\type{int})\type{double[3]}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(AbstractPositions.north) + (9 cm, 0 cm)$)}, opacity=1]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractOrientations}{0, 0}
                \operation[0]{construct(particlesNumber\type{AbstractParticlesNumber})}
                \operation[0]{detroy()}
                \operation[0]{get(iParticle\type{int})\type{double[3]}}
                \operation[0]{set(iParticle\type{int}, orientation\type{double[3]})}
                \operation[0]{add(orientation\type{double[3]})}
                \operation[0]{removeOrientation(iParticle\type{int})}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{construct(particlesNumber\type{AbstractParticlesNumber})}
                \operation{detroy()}
                \operation{get(iParticle\type{int})\type{double[3]}}
                \operation{set(iParticle\type{int}, orientation\type{double[3]})}
                \operation{add(orientation\type{double[3]})}
                \operation{removeOrientation(iParticle\type{int})}
            }
            
            \begin{class}[text width=\mediumTextWidth]{NullOrientations}{0, -5}
                \inherit{AbstractOrientations}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{Orientations}{0, -10}
                \inherit{AbstractOrientations}
                \operationsImplementation{}
            \end{class}            
        \end{scope}
        
        \begin{scope}[shift={($(AbstractOrientations.north) + (10 cm, 10 cm)$)}, opacity=1]
            \begin{class}[text width=\mediumTextWidth]{DipolarMomentsFacade}{0, 0}
                \operation{construct(momentsNorm\type{AbstractMomentsNorm}, 
                                     orientations\type{AbstractOrientations})}
                \operation{destroy()}
                \operation{get(iParticle\type{int})}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractSmallMove.north -| AbstractOrientations.north)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractSmallRotation}{0, 0}
                \operation[0]{construct(orientations\type{AbstractOrientations})}
                \operation[0]{destroy()}
                \operation[0]{set(delta\type{double})}
                \operation[0]{get(iParticle\type{int})\type{double[3]}}
            \end{abstractclass}
            
            \def\operationImplementation{
                \operation{orientation()\type{double[3]}}
                \operation{rotation(iParticle\type{int})\type{double[3]}}
            }
            
            \begin{class}[text width=\mediumTextWidth]{NullRandomOrientations}{0, -3}
                \inherit{AbstractSmallRotation}
                \operationImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{RandomOrientations}{0, -5.5}
                \inherit{AbstractSmallRotation}
                \operationImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarMomentsFacade.north) + (10 cm, 5 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractTotalMoment}{0, 0}
                \operation[0]{get()\type{double[3]}}
                \operation[0]{rotationUpdate(old\type{Particle}, new\type{Particle})}
                \operation[0]{exchangeUpdate(particle\type{Particle})}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{get()\type{double[3]}}
                \operation{rotationUpdate(old\type{Particle}, new\type{Particle})}
                \operation{exchangeUpdate(particle\type{Particle})}
            }

            \begin{class}[text width=\mediumTextWidth]{NullTotalMoment}{0, -3.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{TotalMoment}{0, -6.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(AbstractSmallMove.north)!0.5!(AbstractSmallRotation.north) +
            (0 cm, 4 cm)$)}]
            \begin{class}[text width=\mediumTextWidth]{RandomCoordinatesFacade}{0, 0}
                \operation{position()\type{double[3]}}
                \operation{moment()\type{double[3]}}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(RandomCoordinatesFacade.north) + (11 cm, 0 cm)$)}]
            \begin{class}[text width=\largeTextWidth]{CoordinatesExchangeFacade}{0, 0}
                \operation{add(iParticle\type{int}, position\type{double[3]}, 
                                                    orientation\type{double[3]})}
                \operation{remove(iParticle\type{int})}
            \end{class}
        \end{scope}
        
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{AbstractParallelepipedDomain}{periodicBox}{1}{AbstractPeriodicBox}
    \aggregation{ReciprocalLattice}{periodicBox}{1}{AbstractPeriodicBox}
    \aggregation{ExternalFieldFacade}{parallelepipedDomain}{1}{AbstractParallelepipedDomain}
    \aggregation{ExternalFieldFacade}{fieldExpression}{1}{AbstractFieldExpression}
    
    \aggregation{AbstractDiameters}{particlesNumber}{1}{AbstractParticlesNumber}
    \aggregation{AbstractMomentsNorm}{particlesNumber}{1}{AbstractParticlesNumber}
    
    %\aggregation{AbstractBoxedParticles}{periodicBox}{1}{AbstractPeriodicBox}
    %\aggregation{AbstractBoxedParticles}{positions}{1}{AbstractPositions}
    \aggregation{AbstractInterDiameters}{diameters}{2}{AbstractDiameters}
    \aggregation{AbstractPositions}{periodicBox}{1}{AbstractPeriodicBox}
    \aggregation{AbstractPositions}{particlesNumber}{1}{AbstractParticlesNumber}
    \aggregation{AbstractOrientations}{particlesNumber}{1}{AbstractParticlesNumber}
    
    \aggregation{DipolarMomentsFacade}{momentsNorm}{1}{AbstractMomentsNorm}
    \aggregation{DipolarMomentsFacade}{orientations}{1}{AbstractOrientations}
    
    \aggregation{CoordinatesExchangeFacade}{positions}{1}{AbstractPositions}
    \aggregation{CoordinatesExchangeFacade}{orientations}{1}{AbstractOrientations}
    
    \aggregation{AbstractSmallMove}{positions}{1}{AbstractPositions}

    \aggregation{RandomCoordinatesFacade}{randPositions}{1}{AbstractSmallMove}
    \aggregation{RandomCoordinatesFacade}{randMoments}{1}{AbstractSmallRotation}
    
    \aggregation{AbstractSmallRotation}{orientations}{1}{AbstractOrientations}
    
    \aggregation{TotalMoment}{momentsNorm}{1}{AbstractMomentsNorm}
    \aggregation{TotalMoment}{orientations}{1}{AbstractOrientations}
\end{scope}
