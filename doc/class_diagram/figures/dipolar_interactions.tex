\begin{scope}[shift={($(Particles.north) + (42 cm, 55 cm)$)}]
    \begin{package}{Dipolar interactions}
    
        \begin{scope}[local bounding box=DipolarInteraction]
            \begin{class}[text width=\largeTextWidth]{DipolarInteractionFacade}{0, 8}
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{reset()}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate(old : Particle, new : Particle)}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate(old : Particle, new : Particle)}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate(particle : Particle)}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{volumeChangeRestoration(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            \end{class}
            
            \begin{abstractclass}[text width=\largeTextWidth]{DipolarInteraction}{0, 0}
                \operation[0]{totalEnergy() : double}
                \operation[0]{totalEnergyUsingField() : double}
                \operation[0]{moveEnergy(old : Particle, new : Particle) : double}
                \operation[0]{rotationEnergy(old : Particle, new : Particle) : double}
                \operation[0]{exchangeEnergy(particle : Particle) : double}
                \operation[0]{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation[0]{soloField(particle : Particle) : double[3]}
                \operation[0]{testField(particle : Particle) : double[3]}
            \end{abstractclass}
            
            \begin{abstractclass}[text width=\largeTextWidth]{ReciInteraction}{0, -6}
                \inherit{DipolarInteraction}
                \operation[0]{moveUpdate(old : Particle, new : Particle)}
                \operation[0]{rotationUpdate(old : Particle, new : Particle)}
                \operation[0]{exchangeUpdate(particle : Particle)}
                \operation[0]{volumeChangeRestoration(dilatation : double)}
            \end{abstractclass}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteraction.south) + (-19.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{EwaldReal}{0, 0}
                \inherit{DipolarInteraction}
                \operation[0]{volumeChangeRestoration(dilatation : double)}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{volumeChangeRestoration(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldReal}{0, -2.5}
                \inherit{EwaldReal}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldReal}{0, -8}
                \inherit{EwaldReal}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteraction.south) + (-6.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{EwaldReci}{0, 0}
                \inherit{ReciInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate(old : Particle, new : Particle)}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate(old : Particle, new : Particle)}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate(particle : Particle)}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{volumeChangeRestoration(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldReci}{0, -2}
                \inherit{EwaldReci}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldReci}{0, -9}
                \inherit{EwaldReci}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteraction.south) + (6.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DipolarLayerCorrection}{0, 0}
                \inherit{ReciInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate(old : Particle, new : Particle)}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate(old : Particle, new : Particle)}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate(particle : Particle)}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{volumeChangeRestoration(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullDipolarLayerCorrection}{0, -2}
                \inherit{DipolarLayerCorrection}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{DipolarLayerCorrection}{0, -9}
                \inherit{DipolarLayerCorrection}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteraction.south) + (19.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{EwaldSelf}{0, 0}
                \inherit{DipolarInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldSelf}{0, -2}
                \inherit{EwaldSelf}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldSelf}{0, -7}
                \inherit{EwaldSelf}
                \operationsImplementation{}
            \end{class}
            
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteraction.south) + (32.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{EwaldBound}{0, 0}
                \inherit{DipolarInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldBound}{0, -2}
                \inherit{EwaldBound}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldBound}{0, -7}
                \inherit{EwaldBound}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(DipolarInteraction.south) + (45.5 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{FieldInteraction}{0, 0}
                \inherit{DipolarInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double, oldEnergy : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }

            \begin{class}[text width=\largeTextWidth]{NullFieldInteraction}{0, -2}
                \inherit{FieldInteraction}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{FieldInteraction}{0, -7}
                \inherit{FieldInteraction}
                \operationsImplementation{}
            \end{class}
        \end{scope}
    
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{DipolarInteractionFacade}{ewaldReal}{2}{EwaldReal}
    \aggregation{DipolarInteractionFacade}{ewaldReci}{2}{EwaldReci}
    \aggregation{DipolarInteractionFacade}{dlc}{2}{DipolarLayerCorrection}
    \aggregation{DipolarInteractionFacade}{ewaldSelf}{1}{EwaldSelf}
    \aggregation{DipolarInteractionFacade}{ewaldBound}{2}{EwaldBound}

    \aggregation{DipolarInteraction}{box}{1}{PeriodicBox}

    %\aggregation{EwaldReal}{dipSpheres}{1}{DipolarSpheres}

    %\aggregation{EwaldReci}{dipSpheres}{1}{DipolarSpheres}

    %\aggregation{DipolarLayerCorrection}{dipSpheres}{1}{DipolarSpheres}

    %\aggregation{EwaldSelf}{dipSpheres}{1}{DipolarSpheres}

    \aggregation{EwaldBound}{totalMoment}{1}{ParticlesTotalMoment}

    \aggregation{FieldInteraction}{totalMoment}{1}{ParticlesTotalMoment}
    \aggregation{FieldInteraction}{extField}{1}{ExternalField}
\end{scope}[on background layer]
