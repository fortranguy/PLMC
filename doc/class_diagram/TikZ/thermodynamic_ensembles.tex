\begin{scope}[shift={($(Material.north) + (-5 cm, 85 cm)$)}]
    \begin{package}{Thermodynamic ensembles}
        
        \begin{scope}[local bounding box=EnsembleAlgorithms]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractEnsembleAlgorithms}{0, 0}
                \operation[0]{setAlgorithms()} % in constructor?
                \operation{chooseAlgorithm()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{setAlgorithms()}
            }
            
            \begin{class}[text width=\smallTextWidth]{CanonicalAlgorithms}{-4, -3}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{GrandCanonicalAlgorithms}{4, -3}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{IsobariclAlgorithms}{0, -5.5}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(EnsembleAlgorithms.north) + (15 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractMetropolisAlgorithm}{0, 0}
                \operation[0]{try()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{try()}
            }
            
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractOneSphereChange}{-4, -3}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
                \operation[0]{chooseComponent()}
                \operation{chooseSphere()}
                \operation[0]{applySmallChange()}
                \operation[0]{calculateEnergy()}
                \operation[0]{testMetroplis()}
                \operation[0]{update()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{chooseComponent()}
                \operation{applySmallChange()}
                \operation{calculateEnergy()}
                \operation{testMetroplis()}
                \operation{update()}
            }
            
            \begin{class}[text width=\smallTextWidth]{OneSphereMove}{-4, -8.5}
                \inherit{AbstractOneSphereChange}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{OneSphereRotation}{-4, -13}
                \inherit{AbstractOneSphereChange}
                \operationsImplementation{}
            \end{class}
            
            \def\operationsImplementation{
                \operation{try()}
                % to fill
            }
            
            \begin{class}[text width=\smallTextWidth]{OneSphereExchange}{4, -3}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{TwoSpheresSwitch}{12, -3}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
        \end{scope}

    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{AbstractEnsembleAlgorithms}{algo}{1..*}{AbstractMetropolisAlgorithm}
    
    \aggregation{AbstractMetropolisAlgorithm}{thermostat}{1}{AbstractThermostat}

    \aggregation{OneSphereMove}{dipSpheres}{2}{AbstractDipolarSpheres}
    \aggregation{OneSphereMove}{boxedSpheres}{2}{AbstractBoxedSpheres}
    \aggregation{OneSphereMove}{random}{2}{AbstractRandomPositions}
    \aggregation{OneSphereMove}{short}{2}{AbstractShortInteraction}
    \aggregation{OneSphereMove}{walls}{1}{AbstractWallsInteraction}
    \aggregation{OneSphereMove}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{OneSphereMove}{field}{1}{AbstractFieldInteraction}
    %\compostion{OneSphereMove}{observables}{3}{AbstractObservables}
    
    \aggregation{OneSphereRotation}{dipSpheres}{2}{AbstractDipolarSpheres}
    \aggregation{OneSphereRotation}{random}{2}{AbstractRandomOrientations}
    \aggregation{OneSphereRotation}{dipolar}{2}{DipolarInteractionFacade}
    %\compostion{OneSphereRotation}{observables}{3}{AbstractObservables}
    
    \aggregation{TwoSpheresSwitch}{dipSpheres}{2}{AbstractDipolarSpheres}
    \aggregation{TwoSpheresSwitch}{boxedSpheres}{2}{AbstractBoxedSpheres}
    \aggregation{TwoSpheresSwitch}{short}{2}{AbstractShortInteraction}
    \aggregation{TwoSpheresSwitch}{walls}{1}{AbstractWallsInteraction}
    \aggregation{TwoSpheresSwitch}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{TwoSpheresSwitch}{field}{1}{AbstractFieldInteraction}
    %\compostion{TwoSpheresSwitch}{observables}{3}{AbstractObservables}
    
    \aggregation{OneSphereExchange}{dipSpheres}{2}{AbstractDipolarSpheres}
    \aggregation{OneSphereExchange}{boxedSpheres}{2}{AbstractBoxedSpheres}
    \aggregation{OneSphereExchange}{short}{2}{AbstractShortInteraction}
    \aggregation{OneSphereExchange}{walls}{1}{AbstractWallsInteraction}
    \aggregation{OneSphereExchange}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{OneSphereExchange}{field}{1}{AbstractFieldInteraction}
    \aggregation{OneSphereExchange}{reservoir}{2}{AbstractSpheresReservoir}
    %\compostion{OneSphereExchange}{observables}{3}{AbstractObservables}
\end{scope}
