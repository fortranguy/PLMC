\begin{scope}[local bounding box=Material]
    \begin{package}{Material}
    
        \begin{scope}[local bounding box=Spheres]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractDipolarSpheres}{0, 0}
                \operation{getDiameter() : double}
                \operation[0]{getMomentNorm() : double}
                \operation{getNumSpheres() : int}
                \operation{remove()}
                \operation{add()}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getMomentNorm() : double}
            }
            
            \begin{class}[text width=\smallTextWidth]{ApolarSpheres}{0, -4.5}
                \inherit{AbstractDipolarSpheres}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{DipolarSpheres}{0, -7}
                \inherit{AbstractDipolarSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(Spheres.north) + (0 cm, 5cm)$)},
            local bounding box=Positions]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractPositions}{0, 0}
                \operation{getPosition(iSphere : int) : double[3]}
                \operation{setPosition(iSphere : int, position : double[3])}
                \operation{add(position : double[3])}
                \operation{remove(iSphere : int)}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(Spheres.north) + (12 cm, 5cm)$)},
            local bounding box=Orientations]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractOrientations}{0, 0}
                \operation{getOrientation(iSphere : int) : double[3]}
                \operation{setOrientation(iSphere : int, orientation : double[3])}
                \operation{add(orientation : double[3])}
                \operation{remove(iSphere : int)}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(Positions.north)!0.5!(Orientations.north) + (0, 4cm)$)}]
            \begin{class}[text width=\largeTextWidth]{SphereExchangeFacade}{0, 0}
                \operation{add(iSphere : int, position : double[3], orientation : double[3])}
                \operation{remove(iSphere : int)}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Spheres.north) + (8 cm, 0)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractInterSpheres}{0, 0}
                \operation[0]{getDiameter() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getDiameter() : double}
            }
            
            \begin{class}[text width=\smallTextWidth]{InterSpheres}{0, -3}
                \inherit{AbstractInterSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Spheres.north) - (11 cm, 0)$)}, local bounding box=BoxGeometry]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractBoxGeometry}{0, 0}
                \operation{getSize() : double[3]}
                \operation[0]{getHeight() : double}
                \operation{getWave() : int[3]}
                \operation[0]{vectorPBC(position1 : double[3], position2 : double[3]) : double[3]}
                \operation{distancePBC(position1 : double[3], position2 : double[3]) : double}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getHeight() : double}
                \operation{vectorPBC(position1 : double[3], position2 : double[3]) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{BulkGeometry}{0, -4.5}
                \inherit{AbstractBoxGeometry}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{SlabGeometry}{0, -7.5}
                \inherit{AbstractBoxGeometry}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (11 cm, 0)$)}, local bounding box=ExternalField]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractExternalField}{0, 0}
                \operation[0]{field(position : double[3]) : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{field(position : double[3]) : double[3]}
            }

            \begin{class}[text width=\mediumTextWidth]{ConstantExternalField}{0, -2.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{NonUniformExternalField}{0, -4.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (20 cm, 0)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractSpheresReservoir}{0, 0}
                \operation[0]{getDensity() : double}
                \operation[0]{getExcessChemicalPotential() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getDensity() : double}
                \operation{getExcessChemicalPotential() : double}
            }
            
            \begin{class}[text width=\mediumTextWidth]{SpheresReservoir}{0, -3}
                \inherit{AbstractSpheresReservoir}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (28 cm, 0)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractThermostat}{0, 0}
                \operation[0]{getTemperature() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getTemperature() : double}
            }
            
            \begin{class}[text width=\smallTextWidth]{Thermostat}{0, -2.5}
                \inherit{AbstractThermostat}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) + (0 cm, 16 cm)$)},
            local bounding box=BoxedSpheres]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractBoxedSpheres}{0, 0}
                \operation[0]{accessibleVolume() : double}
                \operation[0]{isInside(position : double[3]) : bool}
                \operation[0]{fold(position : double[3])}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{accessibleVolume() : double}
                \operation{isInside(position : double[3]) : bool}
                \operation{fold(position : double[3])}
            }
            
            \begin{class}[text width=\mediumTextWidth]{BulkBoxedSpheres}{0, -3.5}
                \inherit{AbstractBoxedSpheres}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{SlabBoxedSpheres}{0, -6.5}
                \inherit{AbstractBoxedSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Positions.north) + (0, 12 cm)$)},
                      local bounding box=RandomPositionsBox]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractRandomPositions}{0, 0}
                \operation[0]{position(): double[3]}
                \operation{move(iSphere : int) : double[3]}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{position(): double[3]}
            }
            
            \begin{class}[text width=\smallTextWidth]{BulkRandomPositions}{0, -3}
                \inherit{AbstractRandomPositions}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{SlabRandomPositions}{0, -5}
                \inherit{AbstractRandomPositions}
                \operationsImplementation{}
            \end{class}            
        \end{scope}
        
        \begin{scope}[shift={($(Orientations.north) + (0 cm, 12 cm)$)},
                      local bounding box=RandomOrientationsBox]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractRandomOrientations}{0, 0}
                \operation[0]{orientation(): double[3]}
                \operation[0]{rotation(iSphere : int) : double[3]}
            \end{abstractclass}
            
            \def\operationImplementation{
                \operation{orientation(): double[3]}
                \operation{rotation(iSphere : int) : double[3]}
            }
            
            \begin{class}[text width=\mediumTextWidth]{NullRandomOrientations}{0, -3}
                \inherit{AbstractRandomOrientations}
                \operationImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{RandomOrientations}{0, -5.5}
                \inherit{AbstractRandomOrientations}
                \operationImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(RandomPositionsBox.north)!0.5!(RandomOrientationsBox.north) + 
                               (0 cm, 5 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractRandomCoordinates}{0, 0}
                \operation{position(): double[3]}
                \operation{moment(): double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
            }

            \begin{class}[text width=\mediumTextWidth]{RandomCoordinates}{0, -4}
                \inherit{AbstractRandomCoordinates}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(ExternalField.north) + (0 cm, 16 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractTotalMoment}{0, 0}
                \operation[0]{getTotalMoment() : double[3]}
                \operation[0]{rotationUpdate(old : Particle, new : Particle)}
                \operation[0]{exchangeUpdate(particle : Particle)}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getTotalMoment() : double[3]}
                \operation{rotationUpdate(old : Particle, new : Particle)}
                \operation{exchangeUpdate(particle : Particle)}
            }

            \begin{class}[text width=\mediumTextWidth]{NullTotalMoment}{0, -3.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{TotalMoment}{0, -6.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{AbstractBoxedSpheres}{box}{1}{AbstractBoxGeometry}
    \aggregation{AbstractBoxedSpheres}{dipSpheres}{1}{AbstractDipolarSpheres}
    \aggregation{AbstractInterSpheres}{dipSpheres}{2}{AbstractDipolarSpheres}
    \aggregation{AbstractPositions}{dipSpheres}{1}{AbstractDipolarSpheres}
    \aggregation{AbstractOrientations}{dipSpheres}{1}{AbstractDipolarSpheres}
    \aggregation{SphereExchangeFacade}{dipSpheres}{1}{AbstractDipolarSpheres}
    \aggregation{SphereExchangeFacade}{positions}{1}{AbstractPositions}
    \aggregation{SphereExchangeFacade}{orientations}{1}{AbstractOrientations}
    
    \aggregation{AbstractRandomCoordinates}{randPositions}{1}{AbstractRandomPositions}
    \aggregation{AbstractRandomCoordinates}{randMoments}{1}{AbstractRandomOrientations}
    
    \aggregation{AbstractRandomPositions}{box}{1}{AbstractBoxGeometry}
    \aggregation{AbstractRandomPositions}{dipSpheres}{1}{AbstractDipolarSpheres}
    
    \aggregation{RandomOrientations}{dipSpheres}{1}{AbstractDipolarSpheres}
    
    \aggregation{TotalMoment}{dipSpheres}{1}{AbstractDipolarSpheres}
\end{scope}
