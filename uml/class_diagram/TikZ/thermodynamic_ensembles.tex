\begin{scope}[shift={($(Material.north) + (-5 cm, 85 cm)$)}]
    \begin{package}{Thermodynamic ensembles}
        
        \begin{scope}[local bounding box=EnsembleAlgorithms]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractEnsembleAlgorithms}{0, 0}
                \operation[0]{setAlgorithms()} % in constructor?
                \operation{chooseAlgorithm()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{setAlgorithms()}
            }
            
            \begin{class}[text width=\smallTextWidth]{CanonicalAlgorithms}{-4, -3}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{GrandCanonicalAlgorithms}{4, -3}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{IsobariclAlgorithms}{0, -5.5}
                \inherit{AbstractEnsembleAlgorithms}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(EnsembleAlgorithms.north) + (15 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractMetropolisAlgorithm}{0, 0}
                \operation[0]{try()}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{try()}
            }
            \begin{class}[text width=\smallTextWidth]{MoveOneSphere}{-4, -3}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{RotateOneSphere}{-4, -5.5}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{SwitchTwoSpheres}{4, -3}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\smallTextWidth]{ExchangeOneSphere}{4, -5.5}
                \inherit{AbstractMetropolisAlgorithm}
                \operationsImplementation{}
            \end{class}
        \end{scope}

    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \composition{AbstractEnsembleAlgorithms}{algo}{1..*}{AbstractMetropolisAlgorithm}
    
    \aggregation{AbstractMetropolisAlgorithm}{thermostat}{1}{AbstractThermostat}

    \aggregation{MoveOneSphere}{spheres}{2}{AbstractDipolarSpheres}
    \aggregation{MoveOneSphere}{boxed}{2}{AbstractBoxedSpheres}
    \aggregation{MoveOneSphere}{change}{2}{AbstractSmallChange}
    \aggregation{MoveOneSphere}{short}{2}{AbstractShortInteraction}
    \aggregation{MoveOneSphere}{walls}{1}{AbstractWallsInteraction}
    \aggregation{MoveOneSphere}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{MoveOneSphere}{field}{1}{AbstractFieldInteraction}
    %\compostion{MoveOneSphere}{observables}{3}{AbstractObservables}
    
    \aggregation{RotateOneSphere}{spheres}{2}{AbstractDipolarSpheres}
    \aggregation{RotateOneSphere}{change}{2}{AbstractSmallChange}
    \aggregation{RotateOneSphere}{dipolar}{2}{DipolarInteractionFacade}
    %\compostion{RotateOneSphere}{observables}{3}{AbstractObservables}
    
    \aggregation{SwitchTwoSpheres}{spheres}{2}{AbstractDipolarSpheres}
    \aggregation{SwitchTwoSpheres}{boxed}{2}{AbstractBoxedSpheres}
    \aggregation{SwitchTwoSpheres}{short}{2}{AbstractShortInteraction}
    \aggregation{SwitchTwoSpheres}{walls}{1}{AbstractWallsInteraction}
    \aggregation{SwitchTwoSpheres}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{SwitchTwoSpheres}{field}{1}{AbstractFieldInteraction}
    %\compostion{SwitchTwoSpheres}{observables}{3}{AbstractObservables}
    
    \aggregation{ExchangeOneSphere}{spheres}{2}{AbstractDipolarSpheres}
    \aggregation{ExchangeOneSphere}{boxed}{2}{AbstractBoxedSpheres}
    \aggregation{ExchangeOneSphere}{short}{2}{AbstractShortInteraction}
    \aggregation{ExchangeOneSphere}{walls}{1}{AbstractWallsInteraction}
    \aggregation{ExchangeOneSphere}{dipolar}{2}{DipolarInteractionFacade}
    \aggregation{ExchangeOneSphere}{field}{1}{AbstractFieldInteraction}
    \aggregation{ExchangeOneSphere}{reservoir}{2}{AbstractSpheresReservoir}
    %\compostion{ExchangeOneSphere}{observables}{3}{AbstractObservables}
\end{scope}
