\begin{scope}[local bounding box=Material]
    \begin{package}{Material}
    
        \begin{scope}[local bounding box=Spheres]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractDipolarSpheres}{0, 0}
                \operation{getName() : String}
                \operation{getNum() : int}
                \operation{getDiameter() : double}
                \operation{getPosition(iSphere : int) : double[3]}
                \operation{setPosition(iSphere : int, position : double[3])}
                \operation[0]{getMomentNorm() : double}
                \operation[0]{getMoment(iSphere : int) : double[3]}
                \operation[0]{setMoment(iSphere : int, moment : double[3])}
                \operation[0]{remove(iSphere : int)}
                \operation[0]{add(particle : Particle)}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getMomentNorm() : double}
                \operation{getMoment(iSphere : int) : double[3]}
                \operation{setMoment(iSphere : int, moment : double[3])}
                \operation{remove(iSphere : int)}
                \operation{add(particle : Particle)}
            }
            
            \begin{class}[text width=\mediumTextWidth]{ApolarSpheres}{0, -6.5}
                \inherit{AbstractDipolarSpheres}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{DipolarSpheres}{0, -10.5}
                \inherit{AbstractDipolarSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Spheres.north) + (8 cm, 0)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractInterSpheres}{0, 0}
                \operation[0]{getName() : String}
                \operation[0]{getDiameter() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getName() : String}
                \operation{getDiameter() : double}
            }
            
            \begin{class}[text width=\smallTextWidth]{InterSpheres}{0, -3}
                \inherit{AbstractInterSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Spheres.north) - (11 cm, 0)$)}, local bounding box=BoxGeometry]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractBoxGeometry}{0, 0}
                \operation{getSize() : double[3]}
                \operation[0]{getHeight() : double}
                \operation{getWave() : int[3]}
                \operation[0]{vectorPBC(position1 : double[3], position2 : double[3]) : double[3]}
                \operation{distancePBC(position1 : double[3], position2 : double[3]) : double}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getHeight() : double}
                \operation{vectorPBC(position1 : double[3], position2 : double[3]) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{BulkGeometry}{0, -4.5}
                \inherit{AbstractBoxGeometry}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{SlabGeometry}{0, -7.5}
                \inherit{AbstractBoxGeometry}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (11 cm, 0)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractExternalField}{0, 0}
                \operation[0]{field(position : double[3]) : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{field(position : double[3]) : double[3]}
            }

            \begin{class}[text width=\mediumTextWidth]{ConstantExternalField}{0, -2.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{NonUniformExternalField}{0, -4.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (20 cm, 0)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractSpheresReservoir}{0, 0}
                \operation[0]{getDensity() : double}
                \operation[0]{getExcessChemicalPotential() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getDensity() : double}
                \operation{getExcessChemicalPotential() : double}
            }
            
            \begin{class}[text width=\mediumTextWidth]{SpheresReservoir}{0, -3}
                \inherit{AbstractSpheresReservoir}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxGeometry.north) - (28 cm, 0)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractThermostat}{0, 0}
                \operation[0]{getTemperature() : double}
            \end{abstractclass}
            
            \def\operationsImplementation{
                \operation{getTemperature() : double}
            }
            
            \begin{class}[text width=\smallTextWidth]{Thermostat}{0, -2.5}
                \inherit{AbstractThermostat}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(Spheres.north)!0.5!(BoxGeometry.north) + (0 cm, 16 cm)$)},
            local bounding box=BoxedSpheres]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractBoxedSpheres}{0, 0}
                \operation[0]{getAccessibleVolume() : double}
                \operation[0]{isInsideBox(position : double[3]) : bool}
                \operation[0]{fold(position : double[3])}
                \operation[0]{randomPosition() : double[3]}
                \operation[0]{randomMoment() : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getAccessibleVolume() : double}
                \operation{isInsideBox(position : double[3]) : bool}
                \operation{fold(position : double[3])}
                \operation{randomPosition() : double[3]}
                \operation{randomMoment() : double[3]}
            }
            
            \begin{class}[text width=\mediumTextWidth]{BulkBoxedSpheres}{0, -4.5}
                \inherit{AbstractBoxedSpheres}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\mediumTextWidth]{SlabBoxedSpheres}{0, -8.5}
                \inherit{AbstractBoxedSpheres}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(BoxedSpheres.north) + (-9 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractSmallChange}{0, 0}
                \operation{randomMove(iSphere : int) : double[3]}
                \operation[0]{randomRotation(iSphere : int) : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{randomRotation(iSphere : int) : double[3]}
            }

            \begin{class}[text width=\mediumTextWidth]{SmallMove}{0, -3}
                \inherit{AbstractSmallChange}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{SmallChange}{0, -5}
                \inherit{AbstractSmallChange}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(BoxedSpheres.north) + (8 cm, -5 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractRandomOrientation}{0, 0}
                \operation[0]{orientation() : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{orientation() : double[3]}
            }

            \begin{class}[text width=\smallTextWidth]{NullRandomOrientation}{0, -2.5}
                \inherit{AbstractRandomOrientation}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\smallTextWidth]{RandomOrientation}{0, -4.5}
                \inherit{AbstractRandomOrientation}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(BoxedSpheres.north) + (16 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractTotalMoment}{0, 0}
                \operation[0]{getTotalMoment() : double[3]}
                \operation[0]{rotationUpdate(old : Particle, new : Particle)}
                \operation[0]{exchangeUpdate(particle : Particle)}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getTotalMoment() : double[3]}
                \operation{rotationUpdate(old : Particle, new : Particle)}
                \operation{exchangeUpdate(particle : Particle)}
            }

            \begin{class}[text width=\mediumTextWidth]{NullTotalMoment}{0, -3.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{TotalMoment}{0, -6.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \aggregation{AbstractBoxedSpheres}{box}{1}{AbstractBoxGeometry}
    \aggregation{AbstractBoxedSpheres}{spheres}{1}{AbstractDipolarSpheres}

    \aggregation{AbstractSmallChange}{spheres}{1}{AbstractDipolarSpheres}

    \composition{AbstractBoxedSpheres}{randomOrientation}{1}{AbstractRandomOrientation}
    
    \aggregation{TotalMoment}{spheres}{1}{AbstractDipolarSpheres}
\end{scope}
