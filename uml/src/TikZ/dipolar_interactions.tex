\begin{scope}[shift={($(Material.north) + (40 cm, 45cm)$)}]
    \begin{package}{Dipolar interactions}
    
        \begin{scope}[local bounding box=DipolarInteractions]
            \begin{class}[text width=\largeTextWidth]{DipolarInteractionsFacade}{0, 8}
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{reset()}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate()}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate()}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate()}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{volumeChangeUpdate(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            \end{class}
            
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractDipolarInteractions}{0, 0}
                \operation[0]{totalEnergy() : double}
                \operation[0]{totalEnergyUsingField() : double}
                \operation[0]{moveEnergy(old : Particle, new : Particle) : double}
                \operation[0]{rotationEnergy(old : Particle, new : Particle) : double}
                \operation[0]{exchangeEnergy(particle : Particle) : double}
                \operation[0]{volumeChangeEnergy(dilatation : double) : double}
                \operation[0]{soloField(particle : Particle) : double[3]}
                \operation[0]{testField(particle : Particle) : double[3]}
            \end{abstractclass}
            
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractReciInteraction}{0, -6}
                \inherit{AbstractDipolarInteractions}
                \operation[0]{reset()}
                \operation[0]{countWaveVectors()}
                \operation[0]{moveUpdate()}
                \operation[0]{rotationUpdate()}
                \operation[0]{exchangeUpdate()}
                \operation[0]{volumeChangeUpdate(dilatation : double)}
            \end{abstractclass}           
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteractions.south) + (-19.5 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractEwaldReal}{0, 0}
                \inherit{AbstractDipolarInteractions}
                \operation[0]{volumeChangeUpdate(dilatation : double)}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{volumeChangeUpdate(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldReal}{0, -2.5}
                \inherit{AbstractEwaldReal}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldReal}{0, -8}
                \inherit{AbstractEwaldReal}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{InterEwaldReal}{0, -13.5}
                \inherit{AbstractEwaldReal}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteractions.south) + (-6.5 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractEwaldReci}{0, 0}
                \inherit{AbstractReciInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{reset()}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate()}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate()}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate()}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{volumeChangeUpdate(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldReci}{0, -2}
                \inherit{AbstractEwaldReci}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldReci}{0, -9}
                \inherit{AbstractEwaldReci}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{InterEwaldReci}{0, -16}
                \inherit{AbstractEwaldReci}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteractions.south) + (6.5 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractDipolarLayerCorrection}{0, 0}
                \inherit{AbstractReciInteraction}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{reset()}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{moveUpdate()}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{rotationUpdate()}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{exchangeUpdate()}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{volumeChangeUpdate(dilatation : double)}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullDipolarLayerCorrection}{0, -2}
                \inherit{AbstractDipolarLayerCorrection}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{DipolarLayerCorrection}{0, -9}
                \inherit{AbstractDipolarLayerCorrection}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{InterDipolarLayerCorrection}{0, -16}
                \inherit{AbstractDipolarLayerCorrection}
                \operationsImplementation{}
            \end{class}
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteractions.south) + (19.5 cm, -2 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractEwaldSelf}{0, 0}
                \inherit{AbstractDipolarInteractions}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldSelf}{0, -2}
                \inherit{AbstractEwaldSelf}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldSelf}{0, -7}
                \inherit{AbstractEwaldSelf}
                \operationsImplementation{}
            \end{class}
            
        \end{scope}
        
        \begin{scope}[shift={($(DipolarInteractions.south) + (32.5 cm, -2 cm)$)},
            local bounding box=EwaldBound]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractEwaldBound}{0, 0}
                \inherit{AbstractDipolarInteractions}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }
            
            \begin{class}[text width=\largeTextWidth]{NullEwaldBound}{0, -2}
                \inherit{AbstractEwaldBound}
                \operationsImplementation{}
            \end{class}
            
            \begin{class}[text width=\largeTextWidth]{EwaldBound}{0, -7}
                \inherit{AbstractEwaldBound}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{InterEwaldBound}{0, -12}
                \inherit{AbstractEwaldBound}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(DipolarInteractions.south) + (45.5 cm, -2 cm)$)},
            local bounding box=FieldInteraction]
            \begin{abstractclass}[text width=\largeTextWidth]{AbstractFieldInteraction}{0, 0}
                \inherit{AbstractDipolarInteractions}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{totalEnergy() : double}
                \operation{totalEnergyUsingField() : double}
                \operation{moveEnergy(old : Particle, new : Particle) : double}
                \operation{rotationEnergy(old : Particle, new : Particle) : double}
                \operation{exchangeEnergy(particle : Particle) : double}
                \operation{volumeChangeEnergy(dilatation : double) : double}
                \operation{soloField(particle : Particle) : double[3]}
                \operation{testField(particle : Particle) : double[3]}
            }

            \begin{class}[text width=\largeTextWidth]{NullFieldInteraction}{0, -2}
                \inherit{AbstractFieldInteraction}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\largeTextWidth]{FieldInteraction}{0, -7}
                \inherit{AbstractFieldInteraction}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(EwaldBound.south)!0.5!(FieldInteraction.south) + (0 cm, -7.5 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{AbstractTotalMoment}{0, 0}
                \operation[0]{getTotalMoment() : double[3]}
                \operation[0]{rotationUpdate()}
                \operation[0]{exchangeUpdate()}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{getTotalMoment() : double[3]}
                \operation{rotationUpdate()}
                \operation{exchangeUpdate()}
            }

            \begin{class}[text width=\smallTextWidth]{NullTotalMoment}{0, -3}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\smallTextWidth]{TotalMoment}{0, -5.5}
                \inherit{AbstractTotalMoment}
                \operationsImplementation{}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(EwaldBound.south)!0.5!(FieldInteraction.south) + (13 cm, -7.5 cm)$)}]
            \begin{abstractclass}[text width=\mediumTextWidth]{AbstractExternalField}{0, 0}
                \operation[0]{field(position : double[3]) : double[3]}
            \end{abstractclass}

            \def\operationsImplementation{
                \operation{field(position : double[3]) : double[3]}
            }

            \begin{class}[text width=\mediumTextWidth]{NullExternalField}{0, -2.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}

            \begin{class}[text width=\mediumTextWidth]{NonUniformExternalField}{0, -4.5}
                \inherit{AbstractExternalField}
                \operationsImplementation{}
            \end{class}
        \end{scope}
    
    \end{package}
\end{scope}

\begin{scope}[on background layer]
    \composition{DipolarInteractionsFacade}{ewaldReal}{1}{AbstractEwaldReal}
    \composition{DipolarInteractionsFacade}{ewaldReci}{1}{AbstractEwaldReci}
    \composition{DipolarInteractionsFacade}{dlc}{1}{AbstractDipolarLayerCorrection}
    \composition{DipolarInteractionsFacade}{ewaldSelf}{1}{AbstractEwaldSelf}
    \composition{DipolarInteractionsFacade}{ewaldBound}{1}{AbstractEwaldBound}
    \composition{DipolarInteractionsFacade}{fieldInteraction}{1}{AbstractFieldInteraction}

    \composition{AbstractDipolarInteractions}{box}{1}{AbstractBoxGeometry}

    \composition{EwaldReal}{spheres}{1}{AbstractSpheres}
    \composition{InterEwaldReal}{spheres}{2}{AbstractSpheres}
    \composition{InterEwaldReal}{interSpheres}{1}{AbstractInterSpheres}

    \composition{EwaldReci}{spheres}{1}{AbstractSpheres}
    \composition{InterEwaldReci}{spheres}{2}{AbstractSpheres}

    \composition{DipolarLayerCorrection}{spheres}{1}{AbstractSpheres}
    \composition{InterDipolarLayerCorrection}{spheres}{2}{AbstractSpheres}

    \composition{EwaldSelf}{spheres}{1}{AbstractSpheres}

    \composition{EwaldBound}{totalMoment}{1}{AbstractTotalMoment}
    \composition{InterEwaldBound}{totalMoment}{2}{AbstractTotalMoment}

    \composition{FieldInteraction}{totalMoment}{1}{AbstractTotalMoment}
    \composition{FieldInteraction}{extField}{1}{AbstractExternalField}

    \composition{TotalMoment}{spheres}{1}{AbstractSpheres}
\end{scope}[on background layer]
