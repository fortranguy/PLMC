\documentclass{standalone}

\usepackage{luatex85}
\renewcommand{\familydefault}{\sfdefault}
\input figures/figures.sty

\begin{document}

    \begin{tikzpicture}[scale=\scale, every node/.style={scale=\scale}]

        \begin{scope}
            \begin{abstractclass}[text width=\largeTextWidth]{DESrealComponent}{0, 0}
                \operation{\procedure{construct}{periodicBox: \type{PeriodicBox,
                    boxSizeMemento: \type{BoxSizeMemento},
                    positions: \type{ComponentCoordinates},
                    dipoleMoments: \type{ComponentDipoleMoments}, realPair: \type{DESrealPair}}}}
                \operation{\procedure{destroy}{}}
                \operation{\procedure{target}{boxSizeMemento: \type{BoxSizeMemento},
                    realPair: \type{DESrealPair}}}
                \operation{\procedure{visit}{energy: \type{real}, particle:
                    \type{TemporaryParticle}, iExclude: \type{int}}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESrealComponent.north) + (9 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DESselfComponent}{0, 0}
                \operation{\procedure{construct}{permittivity: \type{Permittivity},
                    dipoleMoments: \type{ComponentDipoleMoments},
                    alpha: \type{DESconvergenceParameter}}}
                \operation{\procedure{destroy}{}}
                \operation{\procedure{reset}{}}
                \operation{\procedure{visit}{}: \type{real}}
                \operation{\procedure{meet}{dipoleMoment: \type{rea[3]}}: \type{real}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESselfComponent.north) + (9 cm, 0 cm)$)}]
            \coordinate (Import) at (0, 0);
            \umlnote[text width=\largeTextWidth]{\import{}:: \\
                \namespace{Environment} :: PeriodicBox, BoxSizeMemento, ReciprocalLattice,
                    Permittivity \\
                \namespace{Mixture} :: Component, MixtureTotalMoment, ComponentCoordinates,
                    ComponentDipoleMoments, TemporaryParticle};
        \end{scope}

        \begin{scope}[shift={($(DESrealComponent.south) - (0 cm, 1.5 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DESrealPair}{0, 0}
                \operation[0]{\procedure{construct}{boxSizeMemento: \type{BoxSizeMemento},
                    permittivity: \type{Permittivity}, alpha: \type{DESconvergenceParameter},
                    domain: \type{DipolarPotentialDomain}}}
                \operation[0]{\procedure{destroy}{}}
                \operation{\procedure{target}{boxSizeMemento: \type{BoxSizeMemento},
                    alpha: \type{DESconvergenceParameter}}}
                \operation[0]{\procedure{reset}{}}
                \operation{\procedure{meet}{vectorIJ: \type{real[3]}, momentI: \type{real[3]},
                    momentJ: \type{real[3]}}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESrealPair.north -| DESselfComponent)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DESconvergenceParameter}{0, 0}
                \operation{\procedure{construct}{periodicBox: \type{PeriodicBox},
                    alphaXboxEdge: \type{real}}}
                \operation{\procedure{destroy}{}}
                \operation{\procedure{getTimesBoxEdge}{}: \type{real}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESrealPair.south) - (0 cm, 2 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DESsurfMixture}{0, 0}
                \operation{\procedure{construct}{periodicBox: \type{PeriodicBox},
                    permittivity: \type{Permittivity}, totalMoment: \type{MixtureTotalMoment}}}
                \operation{\procedure{destroy}{}}
                \operation[0]{\procedure{visit}{}: \type{real}}
                \operation{\procedure{visitTransmutation}{ijComponents \type{int[2]},
                    dipoleMoment2: \type{real[3]}, dipoleMoment1: \type{real[3]}}: \type{real}}
                \operation{\procedure{visitRotation}{iComponent: \type{int},
                    dipoleMoment2: \type{real[3]}, dipoleMoment1: \type{real[3]}}: \type{real}}
                \operation{\procedure{visitAdd}{iComponent: \type{int},
                    dipoleMoment: \type{real[3]}}: \type{real}}
                \operation{\procedure{visitRemove}{iComponent: \type{int},
                    dipoleMoment: \type{real[3]}}: \type{real}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(Import.south) - (0 cm, 4.25 cm)$)}]
            \begin{abstractclass}[text width=\largeTextWidth]{DipolarInteractionsFacade}{0, 0}
                \operation[0]{\procedure{construct}{\ldots}}
                \operation{\procedure{destroy}{}}
                \operation{\procedure{save}{dipolarInteractionsStatic:
                    \type{DipolarInteractionsStatic}, newBoxVolume: \type{real}}}
                \operation{\procedure{restore}{dipolarInteractionsStatic:
                    \type{DipolarInteractionsStatic}}}
                \operation{\procedure{reset}{}}
                \operation{\procedure{visit}{newEnergies: \type{real[:.]},
                    newSharedEnergy: \type{real}, boxVolumeRatio: \type{real},
                    energies: \type{real[:.]}, sharedEnergy: \type{real}}}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESconvergenceParameter.south)!0.5!(DipolarInteractionsFacade.south)
            - (0 cm, 1.5 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{StructureVisitor}{0, 0}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(StructureVisitor.north) - (6 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DESreciWeight}{0, 0}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(StructureVisitor.north) + (6 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DLCweight}{0, 0}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(StructureVisitor.south) - (0 cm, 3 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{StructureFactor}{0, 0}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(StructureFactor.north) - (6 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DESreciStructure}{0, 0}
                \inherit{StructureFactor}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESreciWeight.south)!0.35!(DESreciStructure.north)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DESreciVisitor}{0, 0}
                \inherit{StructureVisitor}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(StructureFactor.north) + (6 cm, 0 cm)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DLCstructures}{0, 0}
                \inherit{StructureFactor}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DLCweight.south)!0.35!(DLCstructures.north)$)}]
            \begin{abstractclass}[text width=\smallTextWidth]{DLCvisitor}{0, 0}
                \inherit{StructureVisitor}
            \end{abstractclass}
        \end{scope}

        \begin{scope}[shift={($(DESreciStructure.south)!0.5!(StructureFactor) + (-1.5 cm, -1.5 cm)$)}]
            \begin{class}[text width=\largeTextWidth]{DipolarInteractionsDynamic}{0, 0}
                \UMLattribute{alpha: \type{DESconvergenceParameter}}
                \UMLattribute{realComponents: \type{DESrealComponent[::]}}
                \UMLattribute{reciVisitor: \type{DESreciVisitor}}
                \UMLattribute{selfComponents: \type{DESselfComponent[:]}}
                \UMLattribute{surfMixture: \type{DESsurfMixture}}
                \UMLattribute{dlcVisitor: \type{DLCvisitor}}
            \end{class}
        \end{scope}

        \begin{scope}[shift={($(StructureFactor.south)!0.5!(DLCstructures) + (1.5 cm, -1.5 cm)$)}]
            \begin{class}[text width=\largeTextWidth]{DipolarInteractionsStatic}{0, 0}
                \UMLattribute{boxSizeMementoReal: \type{BoxSizeMemento}}
                \UMLattribute{realPair: \type{DESrealPair}}
                \UMLattribute{boxSizeMementoReci: \type{BoxSizeMemento}}
                \UMLattribute{reciWeight: \type{DESreciWeight}}
                \UMLattribute{reciStructure: \type{DESreciStructure}}
                \UMLattribute{dlcWeight: \type{DLCweight}}
                \UMLattribute{dlcStructures: \type{DLCstructures}}
            \end{class}
        \end{scope}

        \begin{scope}[on background layer]
            \aggregation{DESrealComponent}{\refName{desRealPair}}{\numRef{1}}{DESrealPair}
            \aggregation{DESrealPair}{\refName{alpha}}{\numRef{1}}{DESconvergenceParameter}

            \aggregation{DESreciVisitor}{\refName{weight}}{\numRef{1}}{DESreciWeight}
            \aggregation{DESreciVisitor}{\refName{structure}}{\numRef{1}}{DESreciStructure}
            \aggregation{DESreciWeight}{\refName{alpha}}{\numRef{1}}{DESconvergenceParameter}

            \aggregation{DESselfComponent}{\refName{alpha}}{\numRef{1}}{DESconvergenceParameter}
            \aggregation{DLCvisitor}{\refName{weight}}{\numRef{1}}{DLCweight}
            \aggregation{DLCvisitor}{\refName{structure}}{\numRef{1}}{DLCstructures}
        \end{scope}

    \end{tikzpicture}

\end{document}
